services:
  dcnn-base:
    build: .
    image: dcnn:latest
    
  worker-8001:
    profiles:
      - sync
      - semi-async
    image: dcnn:latest
    container_name: dcnn-worker-8001
    command: ["./bin/network_worker", "8001"]
    hostname: worker-8001
    ports:
      - "8001:8001"
    networks:
      - dcnn-network
    cpuset: "0-3"
    depends_on:
      - dcnn-base

  worker-8002:
    profiles:
      - sync
      - semi-async
    image: dcnn:latest
    container_name: dcnn-worker-8002
    command: ["./bin/network_worker", "8002"]
    hostname: worker-8002
    ports:
      - "8002:8002"
    networks:
      - dcnn-network
    cpuset: "4-7"
    depends_on:
      - dcnn-base

  sync-coordinator:
    profiles:
      - sync
    image: dcnn:latest
    container_name: dcnn-sync-coordinator
    command: ["./bin/sync_pipeline_coordinator"]
    hostname: coordinator
    ports:
      - "8000:8000"
    networks:
      - dcnn-network
    depends_on:
      - dcnn-base
      - worker-8001
      - worker-8002
    environment:
      - COORDINATOR_HOST=coordinator
      - PROFILE=${PROFILE}
      - WORKER_HOST_8001=worker-8001
      - WORKER_HOST_8002=worker-8002
    cpuset: "8"

  semi-async-coordinator:
    profiles:
      - semi-async
    image: dcnn:latest
    container_name: dcnn-async-coordinator
    command: ["./bin/semi_async_pipeline_coordinator"]
    hostname: semi-async-coordinator
    ports:
      - "8000:8000"
    networks:
      - dcnn-network
    depends_on:
      - dcnn-base
      - worker-8001
      - worker-8002
    environment:
      - COORDINATOR_HOST=semi-async-coordinator
      - WORKER_HOST_8001=worker-8001
      - WORKER_HOST_8002=worker-8002
    cpuset: "8"
  
  single-model:
    profiles:
      - single-model
    image: dcnn:latest
    container_name: dcnn-single-model
    command: ["./bin/cifar10_cnn_trainer"]
    cpuset: "0-3"
    depends_on:
      - dcnn-base

networks:
  dcnn-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16